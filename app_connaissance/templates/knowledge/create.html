{% extends "_layouts/app.html" %}

{% block title %}Publier{% endblock %}

{% block content %}
  <div class="grid gap-6">
    <section class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
      <div>
        <div class="inline-flex items-center rounded-full border border-slate-200 bg-slate-50 px-3 py-1 text-xs font-semibold text-slate-700">Publication</div>
        <h1 class="mt-3 text-3xl font-bold">Créer un contenu</h1>
        <p class="mt-1 text-sm text-slate-600">Capture → indexation → validation → diffusion.</p>
      </div>
      <a class="inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-100" href="{% url 'knowledge_list' %}">← Retour à l'exploration</a>
    </section>

    <section class="grid gap-6 lg:grid-cols-3" x-data="{ tab: 'texte' }">
      <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm lg:col-span-2">
        <form method="post" class="space-y-5" enctype="multipart/form-data">
          {% csrf_token %}

          <div class="grid gap-3 sm:grid-cols-2">
            <label class="block">
              <div class="text-sm font-semibold text-slate-900">Titre</div>
              <input class="mt-2 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" name="title" placeholder="Ex: Procédure d'onboarding — accès outils" required />
            </label>
            <label class="block">
              <div class="text-sm font-semibold text-slate-900">Auteur</div>
              <input class="mt-2 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" name="author" placeholder="Nom de l'auteur" value="{{ frontend.display_name }}" />
            </label>
          </div>

          <div class="grid gap-3">
            <label class="block">
              <div class="text-sm font-semibold text-slate-900">Description courte</div>
              <input class="mt-2 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" name="description" placeholder="Résumé en une phrase (optionnel)" maxlength="500" />
            </label>
          </div>

          <div class="grid gap-3 sm:grid-cols-2">
            <label class="block">
              <div class="text-sm font-semibold text-slate-900">Type</div>
              <select id="knowledge-kind-select" class="mt-2 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" name="kind">
                {% for k in kinds %}
                  <option value="{{ k.id }}">{{ k.name }}</option>
                {% endfor %}
              </select>
            </label>
          </div>

          <div class="grid gap-3 sm:grid-cols-2">
            <label class="block">
              <div class="text-sm font-semibold text-slate-900">Département</div>
              <select id="knowledge-department-select" class="mt-2 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" name="department">
                {% for d in departments %}
                  <option value="{{ d.id }}">{{ d.name }}</option>
                {% endfor %}
              </select>
            </label>
            <label class="block">
              <div class="flex items-baseline justify-between gap-3">
                <span class="text-sm font-semibold text-slate-900">Tags</span>
                <span class="text-xs text-slate-500">séparés par des virgules</span>
              </div>
              <input class="mt-2 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" name="tags" placeholder="onboarding, sécurité, accès" />
            </label>
            <label class="block">
              <div class="text-sm font-semibold text-slate-900">Version</div>
              <input class="mt-2 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" name="numero_version" placeholder="1.0, 2024, v2" value="1.0" />
            </label>
          </div>

          <div class="inline-flex rounded-xl border border-slate-200 bg-white p-1 shadow-sm">
            <button type="button" class="rounded-lg px-3 py-1.5 text-sm font-semibold" :class="tab==='texte' ? 'bg-sky-600 text-white' : 'text-slate-700 hover:bg-slate-50'" @click="tab='texte'">Texte</button>
            <button type="button" class="rounded-lg px-3 py-1.5 text-sm font-semibold" :class="tab==='fichier' ? 'bg-sky-600 text-white' : 'text-slate-700 hover:bg-slate-50'" @click="tab='fichier'">Fichier</button>
            <button type="button" class="rounded-lg px-3 py-1.5 text-sm font-semibold" :class="tab==='video' ? 'bg-sky-600 text-white' : 'text-slate-700 hover:bg-slate-50'" @click="tab='video'">Vidéo</button>
          </div>

          <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4" :class="tab==='texte' ? '' : 'hidden'">
            <div class="flex items-center justify-between gap-3">
              <div class="font-semibold text-slate-900">Éditeur</div>
              <div class="rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-700">Texte</div>
            </div>
            <textarea class="mt-3 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" rows="10" name="content"
              placeholder="Décris la procédure… (objectifs, prérequis, étapes, pièges, liens, REX)"></textarea>
          </div>

          <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4" :class="tab==='fichier' ? '' : 'hidden'">
            <div class="font-semibold text-slate-900">Importer un fichier</div>
            <div class="mt-3 rounded-2xl border border-dashed border-slate-300 bg-white p-6 text-center transition" data-dropzone>
              <div class="mx-auto max-w-sm">
                <div class="text-sm text-slate-600" data-dropzone-label>Glisse-dépose un fichier ici, ou sélectionne-le.</div>
                <input class="mt-4 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm" type="file" name="file" />
              </div>
            </div>
            <div class="mt-3 text-xs text-slate-500">Formats: PDF, DOCX, images, etc.</div>
          </div>

          <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4" :class="tab==='video' ? '' : 'hidden'">
            <div class="font-semibold text-slate-900">Ajouter une vidéo</div>
            <label class="block mt-3">
              <div class="text-sm font-semibold text-slate-900">Lien vidéo</div>
              <input class="mt-2 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" name="video_url" placeholder="https://…" />
            </label>
            <div class="mt-3 text-xs text-slate-500">Plus tard: upload / streaming / chapitrage / transcription.</div>
          </div>

          <div class="border-t border-slate-200"></div>

          <div class="grid gap-3 sm:grid-cols-2">
            <fieldset class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
              <legend class="px-2 text-sm font-semibold text-slate-900">Statut</legend>
              <div class="mt-2 space-y-2 text-sm text-slate-700">
                <label class="flex items-center gap-2">
                  <input type="radio" name="status" value="draft" class="h-4 w-4 text-sky-600" checked />
                  <span>
                    <span class="font-semibold">Brouillon</span>
                    <span class="block text-xs text-slate-500">Enregistré pour toi, non visible par les autres.</span>
                  </span>
                </label>
                <label class="flex items-center gap-2">
                  <input type="radio" name="status" value="in_review" class="h-4 w-4 text-sky-600" />
                  <span>
                    <span class="font-semibold">Envoyer en validation</span>
                    <span class="block text-xs text-slate-500">Ajouté à la file de validation manager.</span>
                  </span>
                </label>
              </div>
            </fieldset>
          </div>

          <div class="flex flex-col gap-2 sm:flex-row sm:justify-end">
            <button type="button" class="inline-flex items-center justify-center rounded-xl border border-slate-300 bg-white px-4 py-2 text-sm font-semibold text-slate-900 hover:bg-slate-50" onclick="document.getElementById('preview-modal')?.showModal()">Prévisualiser</button>
            <button class="inline-flex items-center justify-center rounded-xl bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-sky-500">Enregistrer</button>
          </div>
        </form>
      </div>

      <aside class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
        <div class="text-lg font-bold text-slate-900">Workflow</div>
        <ol class="mt-4 space-y-2 text-sm text-slate-700">
          <li class="flex items-start gap-2"><span class="mt-1 h-2.5 w-2.5 rounded-full bg-indigo-600"></span><span>Capture & création</span></li>
          <li class="flex items-start gap-2"><span class="mt-1 h-2.5 w-2.5 rounded-full bg-indigo-600"></span><span>Organisation & tags</span></li>
          <li class="flex items-start gap-2"><span class="mt-1 h-2.5 w-2.5 rounded-full bg-slate-300"></span><span>Validation manager</span></li>
          <li class="flex items-start gap-2"><span class="mt-1 h-2.5 w-2.5 rounded-full bg-slate-300"></span><span>Publication</span></li>
          <li class="flex items-start gap-2"><span class="mt-1 h-2.5 w-2.5 rounded-full bg-slate-300"></span><span>Mise à jour / archivage</span></li>
        </ol>

        <div class="mt-6 rounded-2xl border border-slate-200 bg-slate-50 p-4">
          <div class="font-semibold text-slate-900">Conseils de rédaction</div>
          <ul class="mt-2 space-y-2 text-sm text-slate-700">
            <li class="flex gap-2"><span class="mt-1 h-2.5 w-2.5 rounded-full bg-emerald-500"></span>Contexte + objectif</li>
            <li class="flex gap-2"><span class="mt-1 h-2.5 w-2.5 rounded-full bg-emerald-500"></span>Étapes reproductibles</li>
            <li class="flex gap-2"><span class="mt-1 h-2.5 w-2.5 rounded-full bg-emerald-500"></span>Pièges & retours d'expérience</li>
            <li class="flex gap-2"><span class="mt-1 h-2.5 w-2.5 rounded-full bg-emerald-500"></span>Mots-clés utiles</li>
          </ul>
        </div>
      </aside>
    </section>

    <!-- Section Quiz (après création) -->
    {% if object.id %}
    <section class="rounded-3xl border-2 border-sky-200 bg-gradient-to-br from-sky-50 to-blue-50 p-8 shadow-sm">
      <div class="flex items-start justify-between gap-4 mb-6">
        <div class="flex items-center gap-4">
          <div class="flex-shrink-0 w-16 h-16 rounded-2xl bg-sky-500 flex items-center justify-center shadow-lg">
            <i data-lucide="brain" class="h-8 w-8 text-white"></i>
          </div>
          <div>
            <h2 class="text-2xl font-bold text-slate-900">Quiz d'évaluation</h2>
            <p class="mt-1 text-sm text-slate-600">Génère automatiquement un quiz basé sur le contenu</p>
          </div>
        </div>
        
        <button type="button" 
                class="inline-flex items-center gap-2 px-6 py-3 rounded-xl bg-sky-600 text-white font-semibold shadow-lg hover:bg-sky-500 transition transform hover:scale-105" 
                onclick="generateQuiz()">
          <i data-lucide="sparkles" class="h-5 w-5"></i>
          Générer le quiz
        </button>
      </div>

      {% if object.quiz %}
        <div class="rounded-2xl border border-sky-200 bg-white p-6 shadow-sm">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-slate-900">{{ object.quiz.titre }}</h3>
            <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-emerald-100 text-emerald-700 text-sm font-semibold">
              <i data-lucide="check-circle" class="h-4 w-4"></i>
              Généré
            </span>
          </div>
          
          <div class="mb-4 flex items-center gap-4 text-sm text-slate-600">
            <span class="flex items-center gap-2">
              <i data-lucide="list" class="h-4 w-4"></i>
              {{ object.quiz.questions.count }} question{{ object.quiz.questions.count|pluralize }}
            </span>
            <span class="flex items-center gap-2">
              <i data-lucide="target" class="h-4 w-4"></i>
              Seuil : {{ object.quiz.seuil_reussite_pct }}%
            </span>
          </div>
          
          <div class="space-y-4 max-h-96 overflow-y-auto">
            {% for question in object.quiz.questions.all %}
              <div class="rounded-xl border border-slate-200 bg-slate-50 p-4">
                <div class="flex items-start gap-3 mb-3">
                  <div class="flex-shrink-0 w-7 h-7 rounded-full bg-sky-100 text-sky-700 flex items-center justify-center text-sm font-bold">
                    {{ forloop.counter }}
                  </div>
                  <p class="font-semibold text-slate-900 flex-1">{{ question.enonce }}</p>
                </div>
                
                <div class="ml-10 space-y-2">
                  {% for choice in question.choices.all %}
                    <div class="flex items-start gap-2 text-sm">
                      {% if choice.is_correct %}
                        <i data-lucide="check-circle" class="h-4 w-4 text-green-600 flex-shrink-0 mt-0.5"></i>
                        <span class="text-green-700 font-medium">{{ choice.texte }}</span>
                      {% else %}
                        <i data-lucide="circle" class="h-4 w-4 text-slate-400 flex-shrink-0 mt-0.5"></i>
                        <span class="text-slate-600">{{ choice.texte }}</span>
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endfor %}
          </div>
          
          <div class="mt-6 pt-4 border-t border-slate-200 flex gap-3">
            <a href="{% url 'knowledge_quiz_take' object.id %}" 
               class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-sky-600 text-white font-semibold hover:bg-sky-500 transition">
              <i data-lucide="play-circle" class="h-4 w-4"></i>
              Tester le quiz
            </a>
            <a href="{% url 'knowledge_quiz_edit' object.id %}" 
               class="inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-slate-300 bg-white text-slate-900 font-semibold hover:bg-slate-50 transition">
              <i data-lucide="pencil" class="h-4 w-4"></i>
              Éditer
            </a>
            <button type="button" 
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-slate-300 bg-white text-slate-900 font-semibold hover:bg-slate-50 transition"
                    onclick="if(confirm('Régénérer le quiz ? Les questions actuelles seront remplacées.')) generateQuiz()">
              <i data-lucide="refresh-cw" class="h-4 w-4"></i>
              Régénérer
            </button>
          </div>
        </div>
      {% else %}
        <div class="rounded-2xl border border-dashed border-sky-300 bg-white p-8 text-center">
          <i data-lucide="file-question" class="h-12 w-12 mx-auto text-slate-400 mb-3"></i>
          <p class="text-slate-600 mb-4">Aucun quiz n'a encore été généré pour ce contenu.</p>
          <p class="text-sm text-slate-500">Clique sur le bouton "Générer le quiz" ci-dessus pour créer automatiquement des questions basées sur ton contenu.</p>
        </div>
      {% endif %}
    </section>
    {% endif %}

  </div>

  {% if frontend.role == 'admin' %}
  <script>
    if (window.InlineCreateSelect) {
      InlineCreateSelect.init({ selectId: 'knowledge-kind-select', model: 'knowledgekind', canAdd: true, apiUrl: '{% url "api_reference_create" %}', modalTitle: 'Nouveau type de contenu', modalHint: 'Saisissez le nom du type (ex: Procédure, Document, Vidéo).', labelField: 'Nom', placeholder: 'Ex: Procédure', successMessage: 'Type ajouté et sélectionné.' });
      InlineCreateSelect.init({ selectId: 'knowledge-department-select', model: 'department', canAdd: true, apiUrl: '{% url "api_reference_create" %}', modalTitle: 'Nouveau département', modalHint: 'Saisissez le nom du département.', labelField: 'Nom', placeholder: 'Ex: IT, RH', successMessage: 'Département ajouté et sélectionné.' });
    }
  </script>
  {% endif %}

  <dialog id="preview-modal" class="w-full max-w-3xl rounded-2xl border border-slate-200 bg-white p-0 shadow-2xl">
    <div class="p-5 sm:p-6">
      <form method="dialog"><button class="absolute right-3 top-3 inline-flex h-9 w-9 items-center justify-center rounded-xl border border-slate-200 bg-white text-slate-700 hover:bg-slate-50" aria-label="Fermer">✕</button></form>
      <h3 class="text-lg font-bold text-slate-900">Prévisualisation</h3>
      <p class="mt-1 text-sm text-slate-600">Aperçu du contenu avant enregistrement.</p>
      <div class="mt-4 rounded-2xl border border-slate-200 bg-slate-50 p-5 space-y-3 text-sm text-slate-800">
        <div class="font-semibold text-slate-900">Structure</div>
        <ul class="list-disc list-inside text-slate-700">
          <li>Objectifs</li>
          <li>Prérequis</li>
          <li>Étapes</li>
          <li>Vérification</li>
          <li>Annexes</li>
        </ul>
      </div>
      <div class="mt-5 flex justify-end">
        <form method="dialog"><button class="inline-flex items-center justify-center rounded-xl bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-sky-500">OK</button></form>
      </div>
    </div>
  </dialog>

  {% if object.id %}
  <script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function generateQuiz() {
    const btn = event.target.closest('button');
    const originalHTML = btn.innerHTML;
    
    // Animation de chargement
    btn.disabled = true;
    btn.innerHTML = '<i data-lucide="loader" class="h-5 w-5 animate-spin"></i> Génération...';
    if (window.lucide) window.lucide.createIcons();
    
    fetch('{% url "generate_quiz" object.id %}', {
      method: 'POST',
      headers: { 'X-CSRFToken': getCookie('csrftoken') },
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        // Animation de succès
        btn.innerHTML = '<i data-lucide="check-circle" class="h-5 w-5"></i> Quiz généré !';
        btn.classList.remove('bg-sky-600', 'hover:bg-sky-500');
        btn.classList.add('bg-green-600');
        if (window.lucide) window.lucide.createIcons();
        
        // Recharger après 1 seconde
        setTimeout(() => location.reload(), 1000);
      } else {
        alert('Erreur : ' + (data.error || 'génération impossible'));
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        if (window.lucide) window.lucide.createIcons();
      }
    })
    .catch(err => {
      console.error(err);
      alert('Erreur réseau. Veuillez réessayer.');
      btn.disabled = false;
      btn.innerHTML = originalHTML;
      if (window.lucide) window.lucide.createIcons();
    });
  }
</script>
  {% endif %}
{% endblock %}